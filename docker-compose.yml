services:
  # ---------------------------------------------------------------------------
  # Frontend Service (React + Vite + Nginx)
  # ---------------------------------------------------------------------------
  client:
    restart: always
    build:
      context: ./tmg-client
      # Multi-stage build handles compilation and Nginx setup.
    ports:
      - "8080:80" # Map host:8080 -> container:80

  # ---------------------------------------------------------------------------
  # Backend Service (Node.js + Express)
  # ---------------------------------------------------------------------------
  server:
    restart: always
    build: 
      context: ./tmg-server
      # Uses the production-optimized multi-stage build (no devDependencies).
      # Note: Changes require a rebuild (`docker-compose up --build`).
    ports:
      - "${PORT}:3000"
    depends_on:
      - db
    environment:
      - PORT=${PORT}
      - NODE_ENV=${NODE_ENV}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:${POSTGRES_PORT}/${POSTGRES_DB}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
      # Note: 'db' refers to the service name defined below.

  # ---------------------------------------------------------------------------
  # Database Service (PostgreSQL + TimescaleDB)
  # ---------------------------------------------------------------------------
  db:
    restart: always
    image: timescale/timescaledb:latest-pg15
    # Preload the TimescaleDB library at startup
    command: ["postgres", "-c", "shared_preload_libraries=timescaledb"]
    # Expose port for local tools (e.g., Prisma Studio, DBeaver)
    ports:
      - "${POSTGRES_PORT}:5432"
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - pgdata_tmg_db:/var/lib/postgresql/data # Persist data across restarts

# ---------------------------------------------------------------------------
# Named Volumes
# ---------------------------------------------------------------------------
volumes:
  pgdata_tmg_db:
