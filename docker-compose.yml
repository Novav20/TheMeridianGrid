version: '3.8'

services:
  # 1. Define the 'client' service
  client:
    restart: always
    build:
      # - Use './tmg-client' as the build context
      context: ./tmg-client
    # - Map host port 8080 to container port 80 (since it uses Nginx)
    ports:
      - "8080:80"

  # 2. Define the 'server' service
  server:
    restart: always
    build: 
      # - Use './tmg-server' as the build context
      context: ./tmg-server
    # - Map host port 3000 to container port 3000
    ports:
      - "${PORT}:3000"
    # - Use 'depends_on' to ensure 'db' starts first
    depends_on:
      - db
    # - Pass environment variables:
    environment:
      - PORT=${PORT}
      - DATABASE_URL=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
  #   - DATABASE_URL=postgresql://user:password@db:5432/tmg_db (Note: 'db' is the hostname)

  # 3. Define the 'db' service
  db:
    restart: always
  # - Use the 'postgres:15-alpine' image
    image: postgres:15-alpine
    # - Set environment variables for POSTGRES_USER, POSTGRES_PASSWORD, and POSTGRES_DB
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    # - Use a volume to persist data: 'pgdata:/var/lib/postgresql/data'
    volumes:
      - pgdata_tmg_db:/var/lib/postgresql/data

# 4. Define the named volumes
volumes:
  pgdata_tmg_db:
